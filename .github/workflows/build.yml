name: Build Android APK

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 🛠️ Клонируем репозиторий
        uses: actions/checkout@v4

      - name: 🏗️ Устанавливаем зависимости
        run: |
          sudo apt update
          sudo apt install -y python3 python3-venv python3-pip openjdk-11-jdk git zip unzip libncurses6
          pip3 install --upgrade pip

      - name: 📦 Устанавливаем Buildozer и зависимости в виртуальном окружении
        run: |
          python3 -m venv venv
          source ./venv/bin/activate
          pip install --upgrade setuptools
          pip install buildozer Cython==0.29.21

      - name: 🔧 Создаём swap-файл (чтобы хватило памяти)
        run: |
          sudo swapoff -a
          sudo rm -f /swapfile
          sudo dd if=/dev/zero of=/swapfile bs=1M count=4096
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile

      - name: 📄 Создаём buildozer.spec (если его нет)
        run: |
          source ./venv/bin/activate
          if [ ! -f buildozer.spec ]; then
            buildozer init
          fi

      - name: 📜 Принимаем лицензии Android SDK
        run: |
          mkdir -p ~/.android
          echo "### Лицензии Android SDK ###" > ~/.android/licenses.cfg
          echo "8933bad161af4178b1185d1a37fbf41ea5269c55" >> ~/.android/licenses.cfg
          echo "d56f5187479451eabf01fb78af6dfcb131a6481e" >> ~/.android/licenses.cfg
          echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" >> ~/.android/licenses.cfg

      - name: 📦 Собираем APK
        run: |
          source ./venv/bin/activate
          mkdir -p bin
          buildozer -v android debug

      - name: 📤 Загружаем APK в артефакты
        uses: actions/upload-artifact@v4
        with:
          name: AutoRegBot-APK
          path: bin/*.apk
