name: Build Android APK

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ› ï¸ ÐšÐ»Ð¾Ð½Ð¸Ñ€ÑƒÐµÐ¼ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹
        uses: actions/checkout@v4

      - name: ðŸ—ï¸ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
        run: |
          sudo apt update
          sudo apt install -y python3 python3-venv python3-pip openjdk-11-jdk git zip unzip libncurses6
          pip3 install --upgrade pip

      - name: ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Buildozer Ð¸ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð² Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð¼ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ð¸
        run: |
          python3 -m venv venv
          source ./venv/bin/activate
          pip install --upgrade setuptools
          pip install buildozer Cython==0.29.21

      - name: ðŸ”§ Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ swap-Ñ„Ð°Ð¹Ð» (Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ñ…Ð²Ð°Ñ‚Ð¸Ð»Ð¾ Ð¿Ð°Ð¼ÑÑ‚Ð¸)
        run: |
          sudo swapoff -a
          sudo rm -f /swapfile
          sudo dd if=/dev/zero of=/swapfile bs=1M count=4096
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile

      - name: ðŸ“„ Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ buildozer.spec (ÐµÑÐ»Ð¸ ÐµÐ³Ð¾ Ð½ÐµÑ‚)
        run: |
          source ./venv/bin/activate
          if [ ! -f buildozer.spec ]; then
            buildozer init
          fi

      - name: ðŸ“œ ÐŸÑ€Ð¸Ð½Ð¸Ð¼Ð°ÐµÐ¼ Ð»Ð¸Ñ†ÐµÐ½Ð·Ð¸Ð¸ Android SDK
        run: |
          mkdir -p ~/.android
          echo "### Ð›Ð¸Ñ†ÐµÐ½Ð·Ð¸Ð¸ Android SDK ###" > ~/.android/licenses.cfg
          echo "8933bad161af4178b1185d1a37fbf41ea5269c55" >> ~/.android/licenses.cfg
          echo "d56f5187479451eabf01fb78af6dfcb131a6481e" >> ~/.android/licenses.cfg
          echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" >> ~/.android/licenses.cfg

      - name: ðŸ“¦ Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ APK
        run: |
          source ./venv/bin/activate
          mkdir -p bin
          buildozer -v android debug

      - name: ðŸ“¤ Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ APK Ð² Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ñ‹
        uses: actions/upload-artifact@v4
        with:
          name: AutoRegBot-APK
          path: bin/*.apk
